<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ pet.name }}ì™€(ê³¼) ëŒ€í™”í•˜ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #fef9f6; color: #4F4A45; margin: 0; padding: 2rem; height: 100vh; box-sizing: border-box; }
        .container { display: flex; gap: 2rem; height: 85vh; max-width: 1200px; margin: 0 auto; }
        
        .profile { flex: 1; background: white; padding: 2rem; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
        .img-container { width: 100%; max-width: 300px; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; margin-bottom: 1rem; background: #eee; position: relative; }
        .profile img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ì´ë¯¸ì§€ ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .img-loading { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: #F79489; }

        /* ì˜¤ë¥¸ìª½ ì±„íŒ…ì°½ */
        .chat-box { flex: 2; background: white; border-radius: 16px; padding: 2rem; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .history { flex-grow: 1; overflow-y: auto; padding: 1rem; border: 1px solid #eee; border-radius: 8px; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        
        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .msg { padding: 0.8rem 1.2rem; border-radius: 12px; max-width: 70%; line-height: 1.5; word-break: break-all; }
        .msg.user { align-self: flex-end; background: #fce0dc; border-bottom-right-radius: 0; color: #333; }
        .msg.model { align-self: flex-start; background: #f0f0f0; border-bottom-left-radius: 0; color: #4F4A45; }
        
        /* [ì¶”ê°€] ìƒê° ì¤‘... ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .msg.thinking { align-self: flex-start; background: #f9f9f9; border-bottom-left-radius: 0; color: #888; font-style: italic; display: none; }
        .dots span { animation: blink 1.4s infinite both; }
        .dots span:nth-child(2) { animation-delay: 0.2s; }
        .dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        .input-area { display: flex; gap: 0.5rem; }
        input { flex-grow: 1; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { padding: 0 1.5rem; background: #F79489; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        button:disabled { background: #fcdad6; cursor: not-allowed; }
    </style>
</head>
<body>
    <nav style="margin-bottom: 1rem; display:flex; justify-content:space-between;">
        <h2 style="color:#F79489; margin:0;">ğŸ¾ {{ pet.name }}ì™€(ê³¼) ëŒ€í™”í•˜ê¸°</h2>
        <div>
            <a href="{{ url_for('home') }}" style="color:#F79489; text-decoration:none; font-weight:bold;">â† ëª©ë¡ìœ¼ë¡œ</a>
        </div>
    </nav>

    <div class="container">
        <aside class="profile">
            <h3>â¤ï¸ {{ pet.name }} â¤ï¸</h3>
            <div class="img-container">
                <img id="pet-img" src="{{ url_for('static', filename='pet_images/' + pet.image_file) }}">
                <div id="img-loading" class="img-loading">
                    <span>ì‚¬ì§„ í˜„ìƒ ì¤‘...</span>
                </div>
            </div>
        </aside>

        <main class="chat-box">
            <div class="history" id="chat-history">
                {% for msg in history %}
                    <div class="msg {{ msg.role }}">{{ msg.content }}</div>
                {% endfor %}
                
                <div id="thinking-bubble" class="msg thinking">
                    ğŸ¾ {{ pet.name }}ê°€ ë§í•˜ëŠ” ì¤‘<span class="dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="msg_input" placeholder="í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ë³´ì„¸ìš”..." autocomplete="off">
                <button id="send_btn">ì „ì†¡</button>
            </div>
        </main>
    </div>

    <script>
        const history = document.getElementById('chat-history');
        const input = document.getElementById('msg_input');
        const btn = document.getElementById('send_btn');
        const thinkingBubble = document.getElementById('thinking-bubble'); // ë¡œë”© ë²„ë¸”
        const petId = {{ pet.id }}; 

        function scroll() { history.scrollTop = history.scrollHeight; }
        scroll();

        // [ì´ë¯¸ì§€ ìƒì„± ë¡œì§]
        window.addEventListener('load', async () => {
            const imgEl = document.getElementById('pet-img');
            const loadingEl = document.getElementById('img-loading');
            
            if (imgEl.src.includes('default.jpg')) {
                loadingEl.style.display = 'flex';
                try {
                    const res = await fetch(`/api/generate_image/${petId}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        imgEl.src = `/static/pet_images/${data.image_file}?t=${new Date().getTime()}`;
                    }
                } catch(e) { console.error(e); }
                finally { loadingEl.style.display = 'none'; }
            }
        });

        // [ì±„íŒ… ì „ì†¡ ë¡œì§]
        async function send() {
            const txt = input.value.trim();
            if (!txt) return;

            // 1. ë‚´ ë©”ì‹œì§€ ì¶”ê°€
            const userDiv = document.createElement('div');
            userDiv.className = 'msg user';
            userDiv.innerText = txt;
            history.insertBefore(userDiv, thinkingBubble); // ë¡œë”©ë°” ìœ„ì— ì¶”ê°€
            
            input.value = '';
            btn.disabled = true; // ì¤‘ë³µ ì „ì†¡ ë°©ì§€

            // 2. "ê°•ì•„ì§€ê°€ ë§í•˜ëŠ” ì¤‘..." í‘œì‹œ ì¼œê¸°
            thinkingBubble.style.display = 'block';
            scroll();

            try {
                const res = await fetch(`/api/chat/${petId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: txt})
                });
                const data = await res.json();
                
                // 3. "ê°•ì•„ì§€ê°€ ë§í•˜ëŠ” ì¤‘..." í‘œì‹œ ë„ê¸°
                thinkingBubble.style.display = 'none';

                // 4. ê°•ì•„ì§€ ë‹µì¥ ì¶”ê°€
                const replyDiv = document.createElement('div');
                replyDiv.className = 'msg model';
                replyDiv.innerText = data.reply || `(ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”: ${data.error})`;
                history.insertBefore(replyDiv, thinkingBubble);
                
            } catch (e) {
                thinkingBubble.style.display = 'none';
                const errDiv = document.createElement('div');
                errDiv.className = 'msg model';
                errDiv.innerText = "(í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”)";
                history.insertBefore(errDiv, thinkingBubble);
            }
            
            btn.disabled = false;
            scroll();
            input.focus();
        }

        btn.onclick = send;
        input.onkeydown = (e) => { 
            if(e.key === 'Enter' && !e.isComposing) send(); // í•œê¸€ ì…ë ¥ ì¤‘ ì—”í„° ë°©ì§€
        }
    </script>
</body>
</html>
