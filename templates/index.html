<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REMEMPET - ê°•ì•„ì§€ ë§Œë“¤ê¸°</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.jpg') }}" type="image/jpeg">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #fef9f6; color: #4F4A45; margin: 0; padding: 2rem; }
        nav { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        nav h2 { margin: 0; color: #F79489; }
        nav a { color: #F79489; text-decoration: none; font-weight: 500; }
        .container { display: flex; flex-wrap: wrap; gap: 2rem; margin-top: 2rem; }
        .sidebar { flex: 1; min-width: 300px; background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .main-content { flex: 2; min-width: 300px; background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        input[type="text"] { 
            display: block; width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #eee; border-radius: 8px; box-sizing: border-box; background: #fdfdfd; 
            font-size: 1rem;
        }
        input[list="breed-list"] { padding: 0.75rem; }
        label { font-weight: bold; margin-bottom: 0.5rem; display: block; color: #555; }
        button { width: 100%; padding: 0.75rem; background-color: #F79489; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        button:hover { background-color: #f57d72; }
        button:disabled { background-color: #fcdad6; }
        #pet_image { width: 100%; border-radius: 12px; margin-top: 1rem; display: none; aspect-ratio: 1/1; object-fit: cover; }
        
        .pet-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .pet-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #fdf0ee; border-radius: 20px;
            padding: 0.5rem 0.75rem 0.5rem 1.25rem;
            font-weight: 500; transition: background 0.2s ease;
        }
        .pet-item:hover { background: #fce0dc; }
        .pet-item a { text-decoration: none; color: #F79489; flex-grow: 1; }
        .pet-item .delete-btn {
            background: none; border: none; color: #F79489; cursor: pointer;
            font-size: 1rem; font-weight: bold; padding: 0.25rem 0.5rem;
            border-radius: 50%; width: 30px; height: 30px; flex-shrink: 0;
        }
        .pet-item .delete-btn:hover { background-color: #f8d7da; color: #721c24; }
        
        #generated-pet { text-align: center; display: none; } 
        #generated-pet h3 { font-size: 1.5rem; color: #333; }
        #generated-pet p { font-size: 1.1rem; color: #4F4A45; line-height: 1.6; }
        #generated-pet a { display: inline-block; width: 80%; padding: 0.75rem; background-color: #F79489; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: bold; text-decoration: none; margin-top: 1rem; }
        #generated-pet a:hover { background-color: #f57d72; }
    </style>
</head>
<body>
    <nav>
        <h2>ğŸ¾ REMEMPET: ë‚˜ì˜ ë°˜ë ¤ê²¬ ê¸°ì–µ ğŸ¾</h2>
        <div>
            <strong>{{ current_user.username }}</strong>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
            <a href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>
    
    <div class="container">
        <aside class="sidebar">
            <h3>â¤ï¸ ë‚˜ì˜ ë°˜ë ¤ê²¬ ê¸°ì–µ ë§Œë“¤ê¸° â¤ï¸</h3>
            <label for="name_input">ì´ë¦„:</label>
            <input type="text" id="name_input">
            
            <label for="breed_input">ì¢…:</label>
            <input list="breed-list" id="breed_input" placeholder="ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥">
            <datalist id="breed-list">
                <option value="ê³¨ë“  ë¦¬íŠ¸ë¦¬ë²„"></option>
                <option value="í¬ë©”ë¼ë‹ˆì•ˆ"></option>
                <option value="í‘¸ë“¤"></option>
                <option value="ì¹˜ì™€ì™€"></option>
                <option value="ë‹¥ìŠ¤í›ˆíŠ¸"></option>
                <option value="ì‹œë°”ê²¬"></option>
                <option value="ë§í‹°ì¦ˆ"></option>
                <option value="ì§„ë—ê°œ"></option>
                <option value="ì‹œì¸„"></option>
                <option value="ìš”í¬ì…” í…Œë¦¬ì–´"></option>
            </datalist>
            
            <label for="color_input">ìƒ‰ê¹”:</label>
            <input type="text" id="color_input">
            
            <label for="age_input">ë‚˜ì´:</label>
            <input type="text" id="age_input">

            <label for="food_input">ì¢‹ì•„í–ˆë˜ ìŒì‹:</label>
            <input type="text" id="food_input" placeholder="ì˜ˆ: êµ¬ìš´ ë‹­ê°€ìŠ´ì‚´">
            
            <label for="background_input">ê°€ê³  ì‹¶ì€ ê³³:</label>
            <input type="text" id="background_input" placeholder="ì˜ˆ: í”„ë‘ìŠ¤ íŒŒë¦¬">
            
            <button id="create_btn">ê°•ì•„ì§€ ë§Œë“¤ê¸°</button>
        </aside>

        <main class="main-content">
            <h3>ğŸ¾ ë‚˜ì˜ ê°•ì•„ì§€ ëª©ë¡ ğŸ¾</h3>
            <div class="pet-list" id="pet-list-container">
                {% if pets %}
                    {% for pet in pets %}
                        <div class="pet-item" data-pet-id="{{ pet.id }}">
                            <a href="{{ url_for('chat_page', pet_id=pet.id) }}" class="pet-link">ğŸ¶ {{ pet.name }} ({{ pet.breed }})</a>
                            <button class="delete-btn">Ã—</button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p id="no-pets-msg">ê¸°ì–µì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”!</p>
                {% endif %}
            </div>
            
            <hr style="margin: 2rem 0;">

            <div id="generated-pet">
                <h3>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</h3>
                <img id="pet_image" src="" alt="ê°•ì•„ì§€ ê·¸ë¦¼">
                <p id="pet_description"></p>
                <a id="go-to-chat" href="#">ê°•ì•„ì§€ì™€ ëŒ€í™”í•˜ëŸ¬ ê°€ê¸°</a>
            </div>
        </main>
    </div>

    <script>
        document.getElementById('create_btn').addEventListener('click', async () => {
            const createBtn = document.getElementById('create_btn');
            const generatedPetDiv = document.getElementById('generated-pet');
            const petImg = document.getElementById('pet_image');
            const goToChatBtn = document.getElementById('go-to-chat');
            const petDesc = document.getElementById('pet_description');
            
            createBtn.disabled = true;
            createBtn.innerText = 'ê°•ì•„ì§€ ê¸°ì–µì¤‘...';
            generatedPetDiv.style.display = 'block';
            petDesc.innerText = 'ì²œêµ­ì—ì„œ ê°•ì•„ì§€ê°€ ë‚´ë ¤ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...';
            petImg.style.display = 'none';
            goToChatBtn.style.display = 'none';

            const data = {
                name: document.getElementById('name_input').value,
                breed: document.getElementById('breed_input').value,
                color: document.getElementById('color_input').value,
                age: document.getElementById('age_input').value,
                favorite_food: document.getElementById('food_input').value,
                background: document.getElementById('background_input').value
            };

            try {
                const response = await fetch('/api/create_pet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    petDesc.innerText = result.first_message; 
                    petImg.src = `data:image/png;base64,${result.image_b64}`; 
                    petImg.style.display = 'block';
                    goToChatBtn.href = `/chat/${result.pet_id}`; 
                    goToChatBtn.style.display = 'inline-block';
                    
                    alert('ê°•ì•„ì§€ê°€ ë‹¹ì‹  ê³ì— ì™”ìŠµë‹ˆë‹¤! ëŒ€í™”ë¥¼ ë‚˜ëˆ„ì–´ ë³´ì„¸ìš”.');
                    location.reload(); 
                } else {
                    petDesc.innerText = `âš ï¸ ìƒì„± ì‹¤íŒ¨: ${result.error}`;
                }
            } catch (error) {
                petDesc.innerText = `âš ï¸ í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜: ${error}`;
            } finally {
                createBtn.disabled = false;
                createBtn.innerText = 'ê°•ì•„ì§€ ë§Œë“¤ê¸°';
            }
        });

        document.getElementById('pet-list-container').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const petItem = e.target.closest('.pet-item');
                const petId = petItem.dataset.petId;
                const petName = petItem.querySelector('.pet-link').innerText.trim(); 
                
                if (confirm(`ì •ë§ë¡œ '${petName}' ê°•ì•„ì§€ì˜ ê¸°ì–µì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    try {
                        const response = await fetch(`/api/delete_pet/${petId}`, {
                            method: 'POST',
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            petItem.remove();
                            alert('ê°•ì•„ì§€ì˜ ê¸°ì–µì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
                        } else {
                            alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜: ${error}`);
                    }
                }
            }
        });
    </script>
</body>
</html>